# FJNU_RM2026智能追踪飞镖系统 - 使用教程

![版本](https://img.shields.io/badge/版本-v1.2-blue)
![更新日期](https://img.shields.io/badge/更新日期-2025--04--21-orange)

## 目录
1. [系统准备](#1-系统准备)
2. [硬件连接](#2-硬件连接)
3. [软件配置](#3-软件配置)
4. [系统调试](#4-系统调试)
5. [操作流程](#5-操作流程)
6. [参数调整](#6-参数调整)
7. [OLED显示介绍](#7-oled显示介绍)
8. [常见问题](#8-常见问题)
9. [维护保养](#9-维护保养)
10. [高级功能](#10-高级功能)

## 1. 系统准备

### 开发环境配置
- **安装Keil MDK 5.38**：用于程序编译与调试
  - 下载地址：[Keil官网](https://www.keil.com/download/)
  - 推荐安装最新版本以获得完整STM32F4支持
- **安装STM32CubeMX 6.8.0**：用于配置STM32外设
  - 下载地址：[ST官网](https://www.st.com/en/development-tools/stm32cubemx.html)
- **安装STM32CubeProgrammer**：用于固件烧录
  - 下载地址：[ST官网](https://www.st.com/en/development-tools/stm32cubeprog.html)

### 准备硬件
- STM32F401单片机开发板
- 2个舵机（推荐型号：MG996R或同等规格，扭矩≥10kg·cm）
- 2个涵道电机（推荐型号：根据飞镖重量选择合适的推力，典型值：30g飞镖配1N推力）
- 电源系统
  - 主电池：11.1V 3S锂电池（≥1500mAh）
  - BEC稳压模块：将电池电压转换为5V（舵机供电）和3.3V（主控供电）
- MPU6050姿态传感器模块
- 0.96寸OLED显示屏（I2C接口，SSD1306驱动）
- 视觉/目标识别系统（可选）
- ST-Link V2调试器

## 2. 硬件连接

### 舵机连接
- 左舵机：连接到TIM2通道1（PA0）
- 右舵机：连接到TIM2通道2（PA1）
- 舵机供电：连接到5V电源（注意：直接从单片机引脚取电可能电流不足）

### 电机连接
- 涵道电机1：连接到TIM3通道1（PA6）
- 涵道电机2：连接到TIM3通道2（PA7）
- 电机电源：直接连接到电池正负极，电调负责降压

### 电源系统连接图
```
电池(11.1V) → 电池监测电路 → 主控供电(3.3V)
     │
     └→ BEC稳压模块(5V) → 舵机供电
     │
     └→ 电调 → 涵道电机
```

### 传感器连接
- MPU6050：连接到I2C1
  - SCL: PB6
  - SDA: PB7
  - VCC: 3.3V
  - GND: GND
- OLED显示屏：连接到I2C1（与MPU6050共用I2C总线）
  - SCL: PB6
  - SDA: PB7
  - VCC: 3.3V
  - GND: GND

### 引脚分配表

| 功能 | 引脚 | 外设 | 说明 |
|------|------|------|------|
| 左舵机 | PA0 | TIM2_CH1 | PWM输出，50Hz |
| 右舵机 | PA1 | TIM2_CH2 | PWM输出，50Hz |
| 电机1 | PA6 | TIM3_CH1 | PWM输出，50Hz |
| 电机2 | PA7 | TIM3_CH2 | PWM输出，50Hz |
| I2C SCL | PB6 | I2C1_SCL | 连接MPU6050和OLED |
| I2C SDA | PB7 | I2C1_SDA | 连接MPU6050和OLED |
| 串口TX | PA9 | USART1_TX | 调试输出 |
| 串口RX | PA10 | USART1_RX | 调试输入 |
| 电池检测 | PC0 | ADC1_IN10 | 电池电压采样 |
| 模式选择 | PC13 | GPIO_Input | 按键输入 |

## 3. 软件配置

### 编译与烧录
1. 使用Keil MDK打开项目文件：`MDK-ARM/dart2.uvprojx`
2. 点击"Build"按钮编译项目
3. 连接ST-Link调试器
4. 点击"Download"按钮将固件烧录到STM32开发板

### 系统初始化参数
系统的初始参数在以下文件中配置：
- `dart_control.h`：基本控制参数定义
  ```c
  // 系统状态定义
  typedef enum {
    SYSTEM_INIT,      // 初始化状态
    SYSTEM_IDLE,      // 空闲状态
    SYSTEM_TARGETING, // 目标追踪状态
    SYSTEM_ATTACK     // 攻击状态
  } SystemState;
  
  // 系统配置参数
  #define TARGET_LOCK_THRESHOLD  5.0f  // 目标锁定阈值(度)
  #define ATTACK_DURATION        3000  // 攻击持续时间(毫秒)
  ```

- `attitude_control.h`：姿态控制PID参数（v1.2版本优化后）
  ```c
  // 横滚控制参数（v1.2优化）
  #define ROLL_KP  2.5f    // 比例系数
  #define ROLL_KI  0.08f   // 积分系数
  #define ROLL_KD  0.6f    // 微分系数
  
  // 俯仰控制参数（v1.2优化）
  #define PITCH_KP  2.5f
  #define PITCH_KI  0.08f
  #define PITCH_KD  0.6f
  
  // 偏航控制参数（v1.2优化）
  #define YAW_KP  1.8f
  #define YAW_KI  0.03f
  #define YAW_KD  0.4f
  ```

### 首次启动配置
1. **传感器校准**：
   - 首次使用需要校准MPU6050
   - 将飞镖置于水平面上，上电
   - 系统会自动进行传感器零点校准
   - OLED屏幕显示校准进度和结果

2. **舵机中位调整**：
   - 通过修改`pwm_control.h`中的`SERVO_LEFT_CENTER`和`SERVO_RIGHT_CENTER`参数
   - 微调至舵面在中位位置时飞镖保持平直状态

## 4. 系统调试

### 串口调试
系统通过UART通信进行调试：
1. 连接USB转TTL模块到USART1（TX: PA9, RX: PA10）
2. 打开串口调试助手，设置波特率为115200，8N1
3. 系统运行后将输出调试信息
4. 支持的串口命令（v1.2新增功能）：
   ```
   # 查询系统状态
   > status
   
   # 切换系统模式
   > mode <idle|targeting|attack>
   
   # 调整PID参数（实时生效）
   > pid roll <kp> <ki> <kd>
   > pid pitch <kp> <ki> <kd>
   > pid yaw <kp> <ki> <kd>
   
   # 手动控制舵机位置（调试用）
   > servo <left|right> <value>
   
   # 手动控制电机输出（调试用）
   > motor <1|2> <value>
   
   # 查看帮助
   > help
   ```

### 参数监控
串口输出的调试信息包含：
- 系统状态
- 姿态数据（Roll、Pitch、Yaw）
- 目标位置数据（X、Y、是否检测到）
- 控制输出值（舵机位置、电机推力）
- 电池电压（v1.2新增）
- 系统运行时间

输出示例：
```
SYS: IDLE | Time: 00:05:23
ATT: Roll=1.2° Pitch=-0.5° Yaw=12.3°
TGT: X=45° Y=10° Detected=Yes Lock=No
OUT: Servo_L=1520 Servo_R=1480 Motor_1=1000 Motor_2=1000
BAT: 11.4V (95%)
```

## 5. 操作流程

### 上电前检查
1. 检查所有连接是否牢固
2. 确保电池电量充足（建议>40%）
3. 飞镖机械结构是否完好
4. 舵机活动是否正常
5. 确保螺旋桨安装牢固

### 系统启动
1. 接通电源
2. 系统将进入初始化状态（`SYSTEM_INIT`）
   - OLED显示"Initializing..."
   - 传感器自检与校准
   - 舵机回中位
   - 电机低速运行测试
3. 完成初始化后进入空闲状态（`SYSTEM_IDLE`）
   - OLED显示"Ready"和系统参数

### 目标追踪模式
1. 系统检测到目标信号后自动进入追踪状态（`SYSTEM_TARGETING`）
   - 也可通过按下模式选择按钮或发送串口命令手动切换
2. OLED显示"Targeting"和目标信息
3. 飞镖姿态将自动调整，对准目标位置
4. 左右舵机将根据目标位置进行相应控制
5. 实时显示锁定状态

### 攻击模式
1. 目标锁定满足条件后：
   - 锁定偏差<5°
   - 锁定持续时间>2秒
2. 系统自动或手动进入攻击状态（`SYSTEM_ATTACK`）
3. OLED显示"ATTACK!"
4. 涵道电机提供推力，飞镖向目标方向飞行
5. 途中姿态控制系统将保持飞镖指向目标
6. 攻击结束后（预设时间或遥控指令），系统回到空闲状态

## 6. 参数调整

### PID参数调整（v1.2优化版）
在`attitude_control.h`文件中可调整PID参数：
```c
// 横滚控制参数
#define ROLL_KP  2.5f    // 增大可提高响应速度，但过大会导致振荡
#define ROLL_KI  0.08f   // 增大可减小静态误差，但过大会导致积分饱和
#define ROLL_KD  0.6f    // 增大可抑制振荡，但过大会放大噪声

// 俯仰控制参数
#define PITCH_KP  2.5f
#define PITCH_KI  0.08f
#define PITCH_KD  0.6f

// 偏航控制参数
#define YAW_KP  1.8f
#define YAW_KI  0.03f
#define YAW_KD  0.4f
```

#### 调参建议
1. **起步阶段**：
   - 先设置KI和KD为0
   - 从小值开始增加KP，直到系统出现轻微振荡
   - 记录此时的KP值，然后降低25%
2. **消除静态误差**：
   - 逐渐增加KI，直到静态误差被消除
   - 注意：KI过大会导致系统不稳定
3. **减少振荡**：
   - 逐渐增加KD，直到振荡被抑制
   - 注意：KD过大会放大系统噪声

### 舵机参数调整
在`attitude_control.h`文件中可调整舵机相关参数：
```c
#define SERVO_CENTER       1500    // 舵机中位值(微秒)
#define SERVO_TRAVEL       500     // 舵机行程(微秒)
#define SERVO_LEFT_CENTER  1500    // 左舵机中位值(v1.2新增，便于微调)
#define SERVO_RIGHT_CENTER 1500    // 右舵机中位值(v1.2新增，便于微调)
#define SERVO_REVERSE      0       // 舵机反向标志(0:正向, 1:反向)
```

### 电机参数调整
在`attitude_control.h`文件中可调整电机相关参数：
```c
#define MOTOR_IDLE         1100    // 电机怠速值(微秒)
#define MOTOR_MAX_THRUST   1800    // 电机最大推力值(微秒)
#define MOTOR_STARTUP      1300    // 电机启动值(v1.2新增，电机启动推力)
#define MOTOR_RAMP_TIME    500     // 电机爬升时间(v1.2新增，毫秒)
```

### 目标锁定参数
在`dart_control.h`文件中可调整目标锁定相关参数：
```c
#define TARGET_LOCK_THRESHOLD  5.0f    // 目标锁定偏差阈值(度)
#define TARGET_LOCK_TIME       2000    // 目标锁定所需时间(毫秒)(v1.2新增)
#define ATTACK_DURATION        3000    // 攻击持续时间(毫秒)
```

## 7. OLED显示介绍

### OLED界面说明（v1.2新增功能）
系统使用0.96寸OLED屏幕显示实时状态信息，界面分为以下几个页面：

1. **主页面**：
   - 显示系统状态：INIT/IDLE/TARGETING/ATTACK
   - 显示电池电量百分比和电压
   - 显示运行时间

2. **姿态页面**：
   - 显示当前姿态角度：Roll、Pitch、Yaw
   - 图形化显示姿态方向
   - 显示陀螺仪原始数据

3. **目标页面**：
   - 显示目标方位角度：X、Y
   - 显示目标锁定状态
   - 显示距离目标的偏差

4. **控制页面**：
   - 显示舵机输出值
   - 显示电机输出值
   - 显示PID控制器输出

### OLED操作说明
- 短按模式选择按键：切换OLED显示页面
- 长按模式选择按键：切换系统工作模式
- 双击模式选择按键：进入参数调整模式（v1.2新增）

## 8. 常见问题

### 舵机抖动问题
- **可能原因**：PID参数不合适、PWM信号不稳定
- **解决方案**：
  1. 减小KP值和KD值
  2. 检查电源质量，确保电压稳定
  3. 检查接线是否松动
  4. 使用示波器查看PWM信号质量
  5. 尝试在舵机电源上并联大电容（470μF/16V）滤波
  6. 更新v1.2固件，使用优化后的PID参数

### 电机不转问题
- **可能原因**：信号线连接问题、电调未正确校准
- **解决方案**：
  1. 检查信号线连接
  2. 重新校准电调（参考电调说明书）
  3. 确认PWM频率设置正确（一般为50Hz）
  4. 测试电机启动值是否适当（v1.2已优化启动过程）
  5. 检查电池电压是否足够

### 姿态数据异常
- **可能原因**：传感器故障、I2C通信问题
- **解决方案**：
  1. 检查MPU6050连接
  2. 重新校准传感器
  3. 排查I2C通信问题
  4. 检查I2C总线上是否有地址冲突
  5. v1.2版本增加了传感器数据滤波，可大幅改善数据质量

### 系统无响应
- **可能原因**：程序异常、电源问题
- **解决方案**：
  1. 重启系统
  2. 检查电源电压（v1.2增加了电池低电量保护）
  3. 重新烧录固件
  4. 检查晶振是否正常工作

### OLED显示异常（v1.2新增故障排除）
- **可能原因**：I2C连接问题、初始化失败
- **解决方案**：
  1. 检查OLED模块接线
  2. 确认I2C地址设置正确（SSD1306默认地址：0x3C）
  3. 重启系统
  4. 尝试降低I2C时钟频率

## 9. 维护保养

### 定期检查项目
- **电池电量监控**：
  - 确保电池电压正常
  - v1.2版本增加了电池监测功能，OLED上可直接查看
- **舵机运动范围测试**：
  - 确认无卡顿现象
  - 建议每次使用前测试
- **电机推力测试**：
  - 确认推力稳定
  - v1.2增加了电机缓启动功能，降低电机损耗
- **固件版本更新**：
  - 及时更新最新固件
  - v1.2是目前最新版本（2025.04.21发布）

### 飞行前检查清单
- **舵面活动范围**：确保舵面活动自如，无卡顿
- **电机启动测试**：低速启动测试电机是否正常运行
- **姿态传感器校准**：确保姿态数据准确，必要时重新校准
- **电源检查**：确认电池电量充足（>40%）
- **紧固件检查**：确保所有螺丝和连接件紧固
- **平衡测试**：手持飞镖检查重心是否合适
- **通信测试**：确认串口通信正常（如有使用）

### 存储要求
- **存放环境**：干燥、常温（建议10-30℃）
- **电池处理**：长期不用时取出电池，电池单独存储
- **清洁要求**：定期清理灰尘，保持散热良好
- **保护措施**：使用专用收纳盒，防止碰撞和损坏

## 10. 高级功能

### 自定义控制模式（v1.2新增）
v1.2版本增加了自定义控制模式，可以通过修改配置文件来实现不同控制策略：
```c
// dart_control.h中添加
typedef enum {
  CONTROL_MODE_NORMAL,    // 普通模式
  CONTROL_MODE_AGGRESSIVE, // 激进模式
  CONTROL_MODE_STABLE     // 稳定模式
} ControlMode;

// 不同模式下的参数预设
static const ControlParams_t ControlPresets[] = {
  // 普通模式
  {2.5f, 0.08f, 0.6f, 2.5f, 0.08f, 0.6f, 1.8f, 0.03f, 0.4f},
  // 激进模式
  {3.2f, 0.1f, 0.8f, 3.2f, 0.1f, 0.8f, 2.2f, 0.05f, 0.6f},
  // 稳定模式
  {1.8f, 0.05f, 0.4f, 1.8f, 0.05f, 0.4f, 1.2f, 0.02f, 0.3f}
};
```

在串口终端中，可以使用以下命令切换模式：
```
> mode control <normal|aggressive|stable>
```

### 数据记录功能（v1.2新增）
v1.2版本增加了飞行数据记录功能，可以通过串口将飞行数据导出：
```
> log start    // 开始记录数据
> log stop     // 停止记录数据
> log export   // 导出记录的数据
```

记录的数据可以用于分析飞行表现，优化控制参数。

### 固件升级
通过ST-Link可以更新飞镖控制系统的固件：
1. 连接ST-Link到飞镖控制系统
2. 运行STM32CubeProgrammer
3. 选择最新固件文件（.hex）
4. 点击"Download"按钮

### 调试模式
v1.2增加了高级调试模式，可以通过特定串口命令进入：
```
> debug enter   // 进入调试模式
> debug sensors // 查看传感器原始数据
> debug pid     // 查看PID计算过程
> debug mem     // 查看内存使用情况
> debug exit    // 退出调试模式
```

---

**注意**：本教程适用于FJNU_RM2026智能追踪飞镖系统v1.2版本，使用其他版本可能存在差异。

**安全警告**：
- 涵道电机高速旋转具有危险性，调试时请做好安全防护，避免人员靠近旋转部件。
- 飞镖系统具有一定动能，请勿对人员或易碎物品进行瞄准。
- 使用锂电池时，避免过充过放，以防发生危险。

**技术支持**：如有问题，请联系[技术支持邮箱/联系方式]